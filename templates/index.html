<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2-Point Discrimination Device</title>

  <style>
    :root{
      --bg: #0b1020;
      --card: rgba(255,255,255,0.96);
      --muted: #6b7280;
      --text: #0f172a;
      --blue: #2563eb;
      --blue-dark:#1e40af;
      --ring: rgba(37,99,235,0.25);
      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#dc2626;
      --radius: 18px;
      --shadow: 0 20px 60px rgba(15, 23, 42, 0.18);
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% -10%, #1e3a8a 0%, transparent 55%),
        radial-gradient(1200px 700px at 110% 10%, #0ea5e9 0%, transparent 50%),
        linear-gradient(160deg, #060814 0%, #0b1020 60%, #0a0f1e 100%);
      padding: 24px;
    }
    .card{
      width:min(92vw, 720px);
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:28px 28px 22px;
      border:1px solid rgba(15,23,42,0.06);
      position:relative;
    }
    .header{
      display:flex; gap:12px; align-items:center; justify-content:center;
      margin-bottom:8px;
    }
    .logo{
      width:42px; height:42px; display:grid; place-items:center;
      background:#eef2ff; border-radius:12px;
      font-weight:800; letter-spacing:0.02em; color:#1e3a8a;
      font-size:0.9rem;
    }
    h1{
      font-size:1.55rem; line-height:1.2; margin:0;
      letter-spacing:-0.02em; text-align:center;
    }
    .subtitle{
      text-align:center; color:var(--muted);
      font-size:0.95rem; margin:6px 0 18px;
    }
    label{
      font-weight:600; font-size:0.95rem; display:block; margin-bottom:8px;
    }
    .input-wrap{ position:relative; }
    input[type="text"]{
      width:100%; padding:12px 12px;
      border-radius:12px; border:1px solid #e5e7eb;
      font-size:1.02rem; outline: none;
      transition: box-shadow .15s ease, border-color .15s ease;
      background:white;
    }
    input[type="text"]:focus{
      border-color:var(--blue);
      box-shadow:0 0 0 6px var(--ring);
    }
    .helper{
      font-size:0.9rem; color:var(--muted); margin-top:8px;
      display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .chips{ display:flex; gap:6px; flex-wrap:wrap; margin-top:10px;}
    .chip{
      border:1px solid #e5e7eb; color:#111827; background:#f9fafb;
      padding:6px 9px; border-radius:999px; font-size:0.85rem; cursor:pointer;
      transition: background .12s ease, border-color .12s ease, transform .05s ease;
      user-select:none;
    }
    .chip:hover{ background:#eef2ff; border-color:#c7d2fe; }
    .chip:active{ transform: translateY(1px); }
    .preview{
      margin-top:12px; padding:10px 12px; border-radius:12px;
      background:#f8fafc; border:1px dashed #e2e8f0; font-size:0.95rem;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .preview .list{ color:#0f172a; font-weight:600;}
    .preview small{ color:var(--muted); font-weight:500;}
    .status{
      margin-top:12px; font-size:0.95rem;
      padding:10px 12px; border-radius:12px; display:none;
    }
    .status.good{ display:block; background:#ecfdf3; color:var(--good); border:1px solid #bbf7d0;}
    .status.warn{ display:block; background:#fffbeb; color:#92400e; border:1px solid #fde68a;}
    .status.bad{ display:block; background:#fef2f2; color:var(--bad); border:1px solid #fecaca;}

    .actions{ margin-top:16px; display:grid; gap:10px;}
    button{
      width:100%; padding:12px 14px; font-size:1rem; font-weight:700;
      border-radius:12px; border:0; cursor:pointer;
      background:var(--blue); color:white;
      transition: background .12s ease, transform .05s ease, opacity .12s ease;
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    button:hover{ background:var(--blue-dark); }
    button:active{ transform: translateY(1px); }
    button[disabled]{ opacity:.6; cursor:not-allowed; transform:none; }

    .secondary{
      background:#0f172a; color:white; font-weight:600;
    }
    .secondary:hover{ background:#111827; }

    .spinner{
      width:16px; height:16px; border-radius:999px;
      border:2px solid rgba(255,255,255,0.5);
      border-top-color:white; animation:spin .7s linear infinite;
    }
    @keyframes spin{ to{ transform:rotate(360deg);} }

    .footer{
      margin-top:14px; text-align:center; color:var(--muted); font-size:0.85rem;
    }

    /* ---- 3D preview panel ---- */
    .viewer-wrap{
      margin-top:16px;
      padding:12px;
      background:#0b1020;
      border-radius:14px;
      display:none;
      border:1px solid rgba(15,23,42,0.2);
    }
    .viewer-title{
      color:white;
      font-size:0.9rem;
      font-weight:700;
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
      opacity:0.9;
    }
    .viewer-hint{
      font-weight:500;
      font-size:0.8rem;
      opacity:0.7;
    }
    #viewer{
      width:100%;
      height:320px;
      display:block;
      border-radius:10px;
      background: radial-gradient(600px 320px at 50% -10%, #1f2937 0%, #0b1020 65%);
      overflow:hidden;
    }
  </style>
</head>
<body>
  <main class="card">
    <div class="header">
      <div class="logo">2PD</div>
      <h1>2-Point Discrimination Device</h1>
    </div>

    <div class="subtitle">
      Generates an STL file that can be used to 3D print a cheaper, accessible, fully customizable
      2-Point Discrimination Device.
    </div>

    <label for="distances">Distances in millimeters</label>
    <div class="input-wrap">
      <input id="distances" type="text" inputmode="decimal"
             placeholder="e.g., 2, 4, 6, 8, 10, 15, 20, 25"
             value="2,4,6,8,10,15,20,25" />
    </div>

    <div class="helper">
      <span>Comma-separated numbers (max 30mm)</span>
      <span id="countHint">8 values</span>
    </div>

    <div class="chips" aria-label="presets">
      <div class="chip" data-preset="2,4,6,8,10,15,20,25">Standard 8-step</div>
      <div class="chip" data-preset="1,2,3,4,5,6,7,8">Fine (1–8mm)</div>
      <div class="chip" data-preset="5,8,10,12,15,20,25,30">Coarse (5–30mm)</div>
      <div class="chip" data-preset="">Clear</div>
    </div>

    <div class="preview" role="status" aria-live="polite">
      <div>
        <div class="list" id="previewList">2, 4, 6, 8, 10, 15, 20, 25</div>
        <small id="previewMeta">Sorted • no duplicates</small>
      </div>
      <small id="previewBadge">✓ Ready</small>
    </div>

    <div id="status" class="status"></div>

    <div class="actions">
      <button id="generateBtn">
        <span id="btnText">Generate STL</span>
      </button>
      <button id="downloadBtn" class="secondary" style="display:none;">
        Download STL
      </button>
    </div>

    <!-- 3D preview panel -->
    <div id="viewerWrap" class="viewer-wrap">
      <div class="viewer-title">
        STL Preview
        <span class="viewer-hint">Drag to rotate • Scroll to zoom</span>
      </div>
      <div id="viewer"></div>
    </div>

    <div class="footer">
      Tip: keep numbers increasing clockwise for easy clinical use.
    </div>
  </main>

  <script type="module">
    import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js";
    import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/controls/OrbitControls.js";
    import { STLLoader } from "https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/loaders/STLLoader.js";

    const input = document.getElementById('distances');
    const btn = document.getElementById('generateBtn');
    const btnText = document.getElementById('btnText');
    const downloadBtn = document.getElementById('downloadBtn');
    const statusEl = document.getElementById('status');
    const previewList = document.getElementById('previewList');
    const previewMeta = document.getElementById('previewMeta');
    const previewBadge = document.getElementById('previewBadge');
    const countHint = document.getElementById('countHint');
    const viewerWrap = document.getElementById('viewerWrap');
    const viewerDiv = document.getElementById('viewer');

    let lastBlobUrl = null;

    function parseDistances(raw){
      const parts = raw.split(',').map(s => s.trim()).filter(Boolean);
      const nums = parts.map(p => Number(p));
      const errors = [];

      if (parts.length === 0) errors.push("Enter at least two distances.");
      if (nums.some(n => Number.isNaN(n))) errors.push("Only numbers are allowed.");
      if (nums.some(n => n <= 0)) errors.push("Distances must be > 0.");
      if (nums.some(n => n > 30)) errors.push("Max allowed distance is 30mm.");

      const rounded = nums.map(n => Math.round(n*1000)/1000);
      const uniq = Array.from(new Set(rounded));
      if (uniq.length !== rounded.length) errors.push("Remove duplicate values.");
      if (uniq.length < 2) errors.push("Enter at least two distances.");

      return { values: uniq.sort((a,b)=>a-b), errors };
    }

    function setStatus(type, msg){
      statusEl.className = `status ${type}`;
      statusEl.textContent = msg;
      statusEl.style.display = "block";
    }
    function clearStatus(){
      statusEl.className = "status";
      statusEl.textContent = "";
      statusEl.style.display = "none";
    }

    function updateUI(){
      const {values, errors} = parseDistances(input.value);
      countHint.textContent = `${values.length} value${values.length===1?"":"s"}`;
      previewList.textContent = values.length ? values.join(', ') : "—";
      previewMeta.textContent = values.length ? "Sorted • no duplicates" : "Waiting for input";

      if (errors.length){
        setStatus("bad", errors[0]);
        previewBadge.textContent = "✕ Fix input";
        btn.disabled = true;
        return;
      }
      clearStatus();
      previewBadge.textContent = "✓ Ready";
      btn.disabled = false;
    }
    input.addEventListener('input', updateUI);
    updateUI();

    document.querySelectorAll('.chip').forEach(chip=>{
      chip.addEventListener('click', ()=>{
        input.value = chip.dataset.preset;
        updateUI();
        input.focus();
      });
    });

    function setLoading(isLoading){
      if (isLoading){
        btn.disabled = true;
        btnText.textContent = "Generating…";
        const sp = document.createElement('span');
        sp.className = 'spinner';
        sp.id = 'spinner';
        btn.appendChild(sp);
      } else {
        const sp = document.getElementById('spinner');
        if (sp) sp.remove();
        btnText.textContent = "Generate STL";
        updateUI();
      }
    }

    // ---------- Three.js viewer ----------
    let scene, camera, renderer, controls, currentMesh;

    function initViewer(){
      if (renderer) return;

      scene = new THREE.Scene();
      scene.background = null;

      const w = viewerDiv.clientWidth;
      const h = viewerDiv.clientHeight;

      camera = new THREE.PerspectiveCamera(35, w/h, 0.1, 2000);
      camera.position.set(0, -90, 90);

      renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
      renderer.setPixelRatio(window.devicePixelRatio || 1);
      renderer.setSize(w, h);
      viewerDiv.innerHTML = "";
      viewerDiv.appendChild(renderer.domElement);

      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.08;

      scene.add(new THREE.HemisphereLight(0xffffff, 0x223344, 1.1));
      const dir = new THREE.DirectionalLight(0xffffff, 1.2);
      dir.position.set(80, 120, 100);
      scene.add(dir);

      window.addEventListener("resize", () => {
        if (!renderer) return;
        const nw = viewerDiv.clientWidth;
        const nh = viewerDiv.clientHeight;
        camera.aspect = nw/nh;
        camera.updateProjectionMatrix();
        renderer.setSize(nw, nh);
      });

      animate();
    }

    function animate(){
      requestAnimationFrame(animate);
      if (controls) controls.update();
      if (renderer && scene && camera) renderer.render(scene, camera);
    }

    function show3DPreviewFromBlob(blob){
      viewerWrap.style.display = "block";

      requestAnimationFrame(() => {
        initViewer();

        const loader = new STLLoader();
        const fr = new FileReader();
        fr.onload = (e) => {
          const geom = loader.parse(e.target.result);

          if (currentMesh){
            scene.remove(currentMesh);
            currentMesh.geometry.dispose();
            currentMesh.material.dispose();
          }

          geom.computeBoundingBox();
          const box = geom.boundingBox;

          // center
          const center = new THREE.Vector3();
          box.getCenter(center);
          geom.translate(-center.x, -center.y, -center.z);

          // scale to nice size
          const size = new THREE.Vector3();
          box.getSize(size);
          const maxDim = Math.max(size.x, size.y, size.z);
          const scale = 70 / maxDim;

          currentMesh = new THREE.Mesh(
            geom,
            new THREE.MeshStandardMaterial({ color: 0xdde3ea, metalness: 0.15, roughness: 0.6 })
          );
          currentMesh.scale.setScalar(scale);
          scene.add(currentMesh);

          controls.target.set(0,0,0);
          controls.update();

          // force correct sizing now that visible
          const w = viewerDiv.clientWidth;
          const h = viewerDiv.clientHeight;
          camera.aspect = w / h;
          camera.updateProjectionMatrix();
          renderer.setSize(w, h);
        };
        fr.readAsArrayBuffer(blob);
      });
    }

    // ---------- Generate ----------
    btn.addEventListener('click', async ()=>{
      const {values, errors} = parseDistances(input.value);
      if (errors.length) return;

      setLoading(true);
      downloadBtn.style.display = "none";
      if (lastBlobUrl) URL.revokeObjectURL(lastBlobUrl);

      try {
        const res = await fetch("/generate", {
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ distances: values.join(",") })
        });

        if (!res.ok){
          let msg = "Generation failed.";
          try {
            const data = await res.json();
            if (data?.error) msg = data.error;
          } catch(e){}
          setStatus("bad", msg);
          return;
        }

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        lastBlobUrl = url;

        setStatus("good", "STL generated successfully.");
        downloadBtn.style.display = "block";
        downloadBtn.onclick = ()=> {
          const a = document.createElement('a');
          a.href = url;
          a.download = "2pd_wheel.stl";
          document.body.appendChild(a);
          a.click();
          a.remove();
        };

        show3DPreviewFromBlob(blob);

      } catch (err){
        setStatus("bad", "Network error. Please try again.");
      } finally{
        setLoading(false);
      }
    });
  </script>
</body>
</html>
